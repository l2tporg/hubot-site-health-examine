// Generated by CoffeeScript 1.10.0
var request = require('request');
var async = require('async');

//  var Doctor = (function() {
function Doctor() {
  console.log("well, I'm exmaming.");
}

Doctor.prototype.examine = function(data, message) {
  var options;
  options = {
    url: data.url
  };
  request.get(options, function(err, res, body) {
    /* 以下二つが実行される前にreturnがされる */
    if (err) {
      message = {
        "status": "error",
        "statusCode": null,
        "discription": "ERROR: \"" + data.url + "\" Connection fail."
      };
    } else if (res.statusCode === data.status) {
      message = {
        "status": "matched",
        "statusCode": "" + res.statusCode,
        "discription": "SUCCESS: \"" + data.url + "\" has been alive :)"
      };
    } else if (res.statusCode !== data.status) {
      message = {
        "status": "unmatched",
        "statusCode": "" + res.statusCode,
        "discription": "ERROR: \"" + data.url + "\" [expect]: \"" + data.status + "\", [actual]: \"" + res.statusCode + "\""
      };
    }
  });
  return message;
};

Doctor.prototype.examineWithPromise = function(data) {
  console.log('started'); //@@
  rp('http://www.google.com')
    .then(function (htmlString) {
    // Process html... 
    console.log('first');
  })
    .catch(function (err) {
    // Crawling failed... 
    console.log('error');
  });
  console.log('finished'); //@
};

Doctor.prototype.examineWithAsync = function(data) {
//  var options = { url: data.url };
////  var result = {};
//  async.series([
//    function(callback) {
//      request.get(options, function(err, res, body) {
//        /* 以下二つが実行される前にreturnがされる */
//        if (err) {
//          result = {
//            "status": "error",
//            "statusCode": null,
//            "discription": "ERROR: \"" + data.url + "\" Connection fail."
//          };
////          callback("e", result);
//        } else if (res.statusCode === data.status) {
//          result = {
//            "status": "matched",
//            "statusCode": "" + res.statusCode,
//            "discription": "SUCCESS: \"" + data.url + "\" has been alive :)"
//          };
////          callback("e", result);
//        } else if (res.statusCode !== data.status) {
//          result = {
//            "status": "unmatched",
//            "statusCode": "" + res.statusCode,
//            "discription": "ERROR: \"" + data.url + "\" [expect]: \"" + data.status + "\", [actual]: \"" + res.statusCode + "\""
//          };
////          callback("e", result);
//        }
//        callback("e", result);
//      });
//    }
//  ], function(err, result) {
//    console.log("request finished");
////    console.log(result); //@@
////    return result;
//  });
//
  async.series([
    function (callback) {
      setTimeout(function() {
        console.log('first');
      },3000);
      callback();
    },
    function (callback) {
      setTimeout(function() {
        console.log('second');
      },3000);
      callback();
    },
    function (callback) {
      setTimeout(function() {
        console.log('third');
      },3000);
      callback();
    }
  ], function (err, results) {
    if (err) {
      throw err;
    }
    setTimeout(function() {
      console.log('all done');
    },3000);
    console.log('series all done. ');
  });
};

module.exports.Doctor = Doctor;
